<html>
<head>
    <title>Live Traffic Router</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk7mnoiWnIoy2YOgV7xOYrx1Mfmzt6p8s&libraries=places"></script>
    <style>
        /* Set the size of the map */
        #map {
            height: 80vh;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
        }
        input {
            padding: 8px;
            width: 250px;
        }
        button {
            padding: 8px 15px;
            background-color: #4285F4;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>

    <h2>Live Traffic Route Finder</h2>
    
    <div class="controls">
        <input id="start" type="text" placeholder="Start Location (or leave for Current)">
        <input id="end" type="text" placeholder="Destination">
        <button onclick="calculateRoute()">Get Route</button>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let trafficLayer;
        let currentLocationMarker;

        function initMap() {
            // 1. Initialize Map centered on a default location
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 0, lng: 0 },
                mapTypeControl: false
            });

            // 2. Initialize Directions Services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // 3. Add the Live Traffic Layer
            // This automatically adds the Green/Yellow/Red colors to the roads
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

            // 4. Set up Autocomplete for input fields
            new google.maps.places.Autocomplete(document.getElementById('start'));
            new google.maps.places.Autocomplete(document.getElementById('end'));

            // 5. Get User's Current Location immediately
            findCurrentLocation();
        }

        function findCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Place a marker for current location
                    currentLocationMarker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        title: "Your Location"
                    });

                    map.setCenter(pos);
                }, () => {
                    alert("Error: The Geolocation service failed.");
                });
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        }

        function calculateRoute() {
            let start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            // If start is empty, use current location marker
            if (!start && currentLocationMarker) {
                start = currentLocationMarker.getPosition();
            }

            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                drivingOptions: {
                    departureTime: new Date(Date.now()), // Required for traffic data
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                } else {
                    alert('Directions request failed due to ' + status);
                }
            });
        }

        // Initialize map on window load
        window.onload = initMap;
    </script>
</body>
</html>